name: Lint and Format

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: PowerShell Linting
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          # Exclude .specify/ and .github/agents/ directories (tooling infrastructure, not product code)
          # Suppress style rules that don't affect functionality
          $excludeRules = @(
            'PSAvoidUsingWriteHost',
            'PSUseSingularNouns',
            'PSUseApprovedVerbs',
            'PSUseShouldProcessForStateChangingFunctions',
            'PSReviewUnusedParameter',
            'PSUseBOMForUnicodeEncodedFile',
            'PSUseToExportFieldsInManifest'
          )

          # Scan all files except .specify/ and .github/agents/ directories
          $filesToScan = Get-ChildItem -Path . -Include *.ps1,*.psm1,*.psd1 -Recurse |
            Where-Object {
              $_.FullName -notmatch '[\\/]\.specify[\\/]' -and
              $_.FullName -notmatch '[\\/]\.git[\\/]' -and
              $_.FullName -notmatch '[\\/]\.github[\\/]agents[\\/]'
            }

          $results = $filesToScan | ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -ExcludeRule $excludeRules }

          if ($results) {
            $results | Format-Table -AutoSize
            Write-Error "PSScriptAnalyzer found $($results.Count) issue(s)"
            exit 1
          }

          Write-Host "✓ PSScriptAnalyzer passed with no issues" -ForegroundColor Green

      - name: Check for trailing whitespace
        shell: pwsh
        run: |
          # Exclude .specify/ and .github/agents/ directories (tooling infrastructure)
          $files = Get-ChildItem -Path . -Include *.ps1,*.psm1,*.md -Recurse |
            Where-Object {
              $_.FullName -notmatch '[\\/]\.git[\\/]' -and
              $_.FullName -notmatch '[\\/]\.specify[\\/]' -and
              $_.FullName -notmatch '[\\/]\.github[\\/]agents[\\/]'
            }
          $issues = @()

          foreach ($file in $files) {
            $content = Get-Content $file.FullName -Raw
            if ($content -match '\s+$') {
              $issues += $file.FullName
            }
          }

          if ($issues.Count -gt 0) {
            Write-Error "Files with trailing whitespace: $($issues -join ', ')"
            exit 1
          }

          Write-Host "✓ No trailing whitespace found" -ForegroundColor Green

      - name: Check file encoding (UTF-8)
        shell: pwsh
        run: |
          # Exclude .specify/ and .github/agents/ directories (tooling infrastructure)
          $files = Get-ChildItem -Path . -Include *.ps1,*.psm1,*.md,*.json -Recurse |
            Where-Object {
              $_.FullName -notmatch '[\\/]\.git[\\/]' -and
              $_.FullName -notmatch '[\\/]\.specify[\\/]' -and
              $_.FullName -notmatch '[\\/]\.github[\\/]agents[\\/]'
            }
          $issues = @()

          foreach ($file in $files) {
            $encoding = [System.IO.File]::ReadAllBytes($file.FullName)[0..2]
            # Check for UTF-8 BOM or assume UTF-8
            if ($encoding.Count -ge 3 -and $encoding[0] -eq 0xEF -and $encoding[1] -eq 0xBB -and $encoding[2] -eq 0xBF) {
              # UTF-8 with BOM - acceptable
            } else {
              # Assume UTF-8 without BOM - acceptable for PowerShell
            }
          }

          Write-Host "✓ File encoding check passed" -ForegroundColor Green
